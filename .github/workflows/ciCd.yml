name: DevSecOps Security Analysis Pipeline

on:
  push:
    branches: [ main, Dast-analysis]
  pull_request:
    branches: [ main ]

env:
  REPORTS_DIR: security-reports
  DOCKER_NET: secnet
  APP_INTERNAL_PORT: 8080
  APP_HOST_PORT: 8082
  ZAP_PATH: /
  IMAGE_NAME: my-app

jobs:
  # 1. Preparation & Build
  build:
    name: Build Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Create reports directory
        run: |
          rm -rf ${{ env.REPORTS_DIR }}
          mkdir -p ${{ env.REPORTS_DIR }}

      - name: Build with Maven
        run: |
          cd FetchingData
          mvn clean package -DskipTests

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: FetchingData/target/*.jar

  # 2. SCA - Software Composition Analysis
  sca:
    name: SCA - Dependency Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Create reports directory
        run: mkdir -p ${{ env.REPORTS_DIR }}

      - name: Run Snyk SCA Scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "Installing Snyk..."
          npm install -g snyk
          
          echo "Authenticating with Snyk..."
          snyk auth $SNYK_TOKEN
          
          echo "Running Snyk test..."
          cd FetchingData
          snyk test --file=pom.xml --package-manager=maven --json \
            > ../${{ env.REPORTS_DIR }}/sca-raw.json 2>&1 || true
          
          echo "Verifying report was created..."
          ls -lh ../${{ env.REPORTS_DIR }}/sca-raw.json || echo "WARNING: Report file not created"

      - name: Parse SCA Report
        run: |
          if [ -f "${{ env.REPORTS_DIR }}/sca-raw.json" ]; then
            echo "Report file found, parsing..."
            cd parsers
            python3 parsca.py \
              ../${{ env.REPORTS_DIR }}/sca-raw.json \
              ../${{ env.REPORTS_DIR }}/sca-findings.txt
          else
            echo "ERROR: sca-raw.json not found"
            exit 1
          fi

      - name: Upload SCA Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sca-reports
          path: |
            ${{ env.REPORTS_DIR }}/sca-raw.json
            ${{ env.REPORTS_DIR }}/sca-findings.txt

  # 3. SAST - Static Application Security Testing
  sast:
    name: SAST - SonarQube Analysis
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Create reports directory
        run: mkdir -p ${{ env.REPORTS_DIR }}

      - name: Build project
        run: |
          cd FetchingData
          mvn clean package -DskipTests

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=devsecopsSadki_projetDevsecopsAI
            -Dsonar.organization=devsecopssadki
            -Dsonar.sources=FetchingData/src
            -Dsonar.java.binaries=FetchingData/target/classes

      - name: Export SonarQube Results
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          curl -u $SONAR_TOKEN: \
            "$SONAR_HOST_URL/api/issues/search?componentKeys=my-project&ps=500" \
            -o ${{ env.REPORTS_DIR }}/sast-report.json

      - name: Parse SAST Report
        run: |
          python3 parsers/sast/parsast.py \
            ${{ env.REPORTS_DIR }}/sast-report.json \
            ${{ env.REPORTS_DIR }}/sast-findings.txt

      - name: Upload SAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-reports
          path: |
            ${{ env.REPORTS_DIR }}/sast-report.json
            ${{ env.REPORTS_DIR }}/sast-findings.txt

  # 4. Build Docker Image
  docker_build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [sca, sast]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: FetchingData/target

      - name: Build Docker Image
        run: |
          cd FetchingData
          docker build --no-cache -t ${{ env.IMAGE_NAME }}:latest .
          echo "âœ… Docker image built successfully"

      - name: Save Docker Image
        run: |
          docker save ${{ env.IMAGE_NAME }}:latest | gzip > docker-image.tar.gz

      - name: Upload Docker Image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar.gz

  # 5. DAST - Dynamic Application Security Testing
  dast:
    name: DAST - OWASP ZAP Scan
    runs-on: ubuntu-latest
    needs: docker_build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker Image
        run: |
          docker load < docker-image.tar.gz

      - name: Create reports directory
        run: |
          mkdir -p ${{ env.REPORTS_DIR }}
          chmod 777 ${{ env.REPORTS_DIR }}

      - name: Create Docker Network
        run: |
          docker network create ${{ env.DOCKER_NET }} || true

      - name: Start Application Container
        run: |
          docker rm -f app-container 2>/dev/null || true
          
          docker run -d \
            --name app-container \
            --network ${{ env.DOCKER_NET }} \
            -p ${{ env.APP_HOST_PORT }}:${{ env.APP_INTERNAL_PORT }} \
            -e SERVER_PORT=${{ env.APP_INTERNAL_PORT }} \
            ${{ env.IMAGE_NAME }}:latest
          
          echo "Waiting for app to be ready..."
          READY=0
          for i in $(seq 1 60); do
            if curl -fsS "http://localhost:${{ env.APP_HOST_PORT }}${{ env.ZAP_PATH }}" >/dev/null 2>&1; then
              READY=1
              echo "âœ… App is ready"
              break
            fi
            sleep 2
          done
          
          if [ "$READY" -ne 1 ]; then
            echo "âŒ App did not become ready"
            docker logs app-container
            exit 1
          fi

      - name: Verify Network Connectivity
        run: |
          echo "Testing connectivity..."
          curl -s -o /dev/null -w "HTTP %{http_code}\n" \
            "http://localhost:${{ env.APP_HOST_PORT }}${{ env.ZAP_PATH }}" || echo "Failed"
          
          docker run --rm --network ${{ env.DOCKER_NET }} curlimages/curl:8.10.1 \
            -s -o /dev/null -w "HTTP %{http_code}\n" \
            "http://app-container:${{ env.APP_INTERNAL_PORT }}${{ env.ZAP_PATH }}" || echo "Failed"

      - name: Run OWASP ZAP Scan
        run: |
          TARGET_URL="http://app-container:${{ env.APP_INTERNAL_PORT }}${{ env.ZAP_PATH }}"
          echo "Starting ZAP scan against ${TARGET_URL}"
          
          touch ${{ env.REPORTS_DIR }}/dast-report.json
          touch ${{ env.REPORTS_DIR }}/dast-report.html
          chmod 666 ${{ env.REPORTS_DIR }}/dast-report.*
          
          # Preflight check
          docker run --rm --network ${{ env.DOCKER_NET }} curlimages/curl:8.10.1 \
            -s -o /dev/null -w "%{http_code}" "${TARGET_URL}" | grep -Eq '^(200|302)$'
          
          # Run ZAP scan
          docker run --rm \
            --network ${{ env.DOCKER_NET }} \
            --user 0 \
            -v "$PWD/${{ env.REPORTS_DIR }}:/zap/wrk/:rw" \
            -w /zap/wrk \
            zaproxy/zap-stable zap-baseline.py \
              -t "${TARGET_URL}" \
              -g gen.conf \
              -J dast-report.json \
              -r dast-report.html \
              -m 5 \
              -I || true
          
          echo "Verifying reports..."
          ls -lh ${{ env.REPORTS_DIR }}/dast-report.json || echo "WARNING: JSON not created"
          ls -lh ${{ env.REPORTS_DIR }}/dast-report.html || echo "WARNING: HTML not created"

      - name: Stop Application
        if: always()
        run: |
          docker stop app-container 2>/dev/null || true
          docker rm app-container 2>/dev/null || true
          docker network rm ${{ env.DOCKER_NET }} 2>/dev/null || true

      - name: Parse DAST Report
        run: |
          if [ -f "${{ env.REPORTS_DIR }}/dast-report.json" ]; then
            echo "DAST report found, parsing..."
            cd parsers/dast
            python3 pardast.py \
              ../../${{ env.REPORTS_DIR }}/dast-report.json \
              ../../${{ env.REPORTS_DIR }}/dast-findings.txt
          else
            echo "WARNING: dast-report.json not found"
            echo "No DAST findings to report." > ${{ env.REPORTS_DIR }}/dast-findings.txt
          fi

      - name: Upload DAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-reports
          path: |
            ${{ env.REPORTS_DIR }}/dast-report.json
            ${{ env.REPORTS_DIR }}/dast-report.html
            ${{ env.REPORTS_DIR }}/dast-findings.txt

  # 6. Generate Security Policies with AI
  generate_policies:
    name: Generate Security Policies
    runs-on: ubuntu-latest
    needs: [sca, sast, dast]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Create reports directory
        run: mkdir -p ${{ env.REPORTS_DIR }}

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Consolidate reports
        run: |
          cp artifacts/sca-reports/* ${{ env.REPORTS_DIR }}/ 2>/dev/null || true
          cp artifacts/sast-reports/* ${{ env.REPORTS_DIR }}/ 2>/dev/null || true
          cp artifacts/dast-reports/* ${{ env.REPORTS_DIR }}/ 2>/dev/null || true
          ls -lh ${{ env.REPORTS_DIR }}/

      - name: Install Python dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Generate Policies with LLM
        run: |
          python3 scripts/generate_policies.py \
            --input ${{ env.REPORTS_DIR }}/sast-findings.txt \
            --output ${{ env.REPORTS_DIR }}/security-policies.json \
            --model llama3.3 \
            --framework nist-csf

      - name: Upload Policy Report
        uses: actions/upload-artifact@v4
        with:
          name: security-policies
          path: ${{ env.REPORTS_DIR }}/security-policies.json

  # 7. Summary & Archive
  summary:
    name: Display Summary & Archive
    runs-on: ubuntu-latest
    needs: generate_policies
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create reports directory
        run: mkdir -p ${{ env.REPORTS_DIR }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Consolidate all reports
        run: |
          cp artifacts/sca-reports/* ${{ env.REPORTS_DIR }}/ 2>/dev/null || true
          cp artifacts/sast-reports/* ${{ env.REPORTS_DIR }}/ 2>/dev/null || true
          cp artifacts/dast-reports/* ${{ env.REPORTS_DIR }}/ 2>/dev/null || true
          cp artifacts/security-policies/* ${{ env.REPORTS_DIR }}/ 2>/dev/null || true

      - name: Generate Summary
        run: |
          echo "======================================"
          echo "PIPELINE RESULTS SUMMARY"
          echo "======================================"
          
          if [ -f "${{ env.REPORTS_DIR }}/sast-findings.txt" ]; then
            FINDING_COUNT=$(grep -c "^--- Finding" ${{ env.REPORTS_DIR }}/sast-findings.txt || echo "0")
            echo "Total SAST Findings: $FINDING_COUNT"
          fi
          
          if [ -f "${{ env.REPORTS_DIR }}/sca-findings.txt" ]; then
            SCA_COUNT=$(grep -c "Vulnerability" ${{ env.REPORTS_DIR }}/sca-findings.txt || echo "0")
            echo "Total SCA Findings: $SCA_COUNT"
          fi
          
          if [ -f "${{ env.REPORTS_DIR }}/dast-findings.txt" ]; then
            DAST_COUNT=$(grep -c "^--- DAST Finding" ${{ env.REPORTS_DIR }}/dast-findings.txt || echo "0")
            echo "Total DAST Findings: $DAST_COUNT"
          fi
          
          if [ -f "${{ env.REPORTS_DIR }}/security-policies.json" ]; then
            echo "Security policies generated âœ…"
          fi
          
          echo "======================================"

      - name: Archive All Reports
        uses: actions/upload-artifact@v4
        with:
          name: complete-security-reports
          path: ${{ env.REPORTS_DIR }}/*

      - name: Create Summary Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = '## ðŸ”’ Security Analysis Summary\n\n';
            
            try {
              const sastFile = '${{ env.REPORTS_DIR }}/sast-findings.txt';
              if (fs.existsSync(sastFile)) {
                const content = fs.readFileSync(sastFile, 'utf8');
                const count = (content.match(/^--- Finding/gm) || []).length;
                summary += `- **SAST Findings:** ${count}\n`;
              }
            } catch (e) {}
            
            summary += '\nðŸ“Š View complete reports in the workflow artifacts.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # 8. Deploy (only on main branch)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: summary
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Stop old container
            docker stop ${{ env.IMAGE_NAME }} || true
            docker rm ${{ env.IMAGE_NAME }} || true
            
            # Run new container
            docker run -d \
              --name ${{ env.IMAGE_NAME }} \
              --restart unless-stopped \
              -p 80:8080 \
              ${{ env.IMAGE_NAME }}:latest
            
            # Clean up
            docker image prune -af